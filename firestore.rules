
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is the owner of a document.
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Helper function to check if the requesting user is the admin.
    // Ensure NEXT_PUBLIC_ADMIN_EMAIL is set in your environment.
    function isAdmin() {
      return request.auth != null && request.auth.token.email in ["sk@gmail.com", "thegreatfarhaz07@gmail.com", "shahbazkhan19111@gmail.com"];
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Anyone can read user profiles.
      allow read: if true;

      // Allow a user to create their own document.
      allow create: if isOwner(userId);
      
      // Allow a user to update their own profile, or an admin to update any profile.
      // Also specifically allow updating listingCredits and transactions by the owner.
      allow update: if isOwner(userId) || isAdmin();

      // Only admins can delete user documents.
      allow delete: if isAdmin();

      // Rules for the 'reviews' subcollection
      match /reviews/{reviewId} {
        // Anyone can read reviews.
        allow read: if true;
        
        // Only an authenticated user can create a review for someone else.
        allow create: if request.auth != null && request.auth.uid != userId;
        
        // Only the user who wrote the review or an admin can update or delete it.
        allow update, delete: if isOwner(resource.data.reviewerId) || isAdmin();
      }
    }

    // Rules for the 'properties' collection
    match /properties/{propertyId} {
      // Allow anyone to read any property listing.
      allow read: if true;
      
      // Allow any authenticated user to create a new property.
      allow create: if request.auth != null;
      
      // Allow wishlist count updates by any authenticated user.
      // Allow full updates by owner or admin.
      allow update: if (isOwner(resource.data.userId) || isAdmin()) ||
                       (request.auth != null &&
                        request.resource.data.diff(resource.data).changedKeys().hasOnly(['wishlistCount']));

      // Only allow the user who owns the property or an admin to delete it.
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // Rules for the 'leads' collection
    match /leads/{leadId} {
      // Only an authenticated user can create a lead.
      allow create: if request.auth != null;
      
      // Only admins can read, update, or delete leads.
      allow read, update, delete: if isAdmin();
    }
    
    // Rules for the 'app_settings' collection
    match /app_settings/{settingsId} {
      // Allow any user to read the settings.
      allow read: if true;
      
      // Only allow admins to write/update the settings.
      allow write: if isAdmin();
    }

    // Rules for the 'notifications' collection (historical log)
    match /notifications/{notificationId} {
        // Only admins can read and write historical notifications.
        allow read, write: if isAdmin();
    }
  }
}
