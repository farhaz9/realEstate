/**
 * This ruleset enforces a strict user-ownership security model for the Delhi Estate Luxe application.
 *
 * Core Philosophy:
 * All user-generated data is private by default. A user can only access data that exists within their own
 * user document tree. This ensures strong data isolation between users.
 *
 * Data Structure:
 * The data is organized hierarchically. All user-specific content, such as their profile and property listings,
 * is nested under a top-level `/users/{userId}` document. For example, a user's properties are stored at
 * `/users/{userId}/properties/{propertyId}`.
 *
 * Key Security Decisions:
 * - User Isolation: A user can only interact with their own data. They cannot read, write, or even see
 *   data belonging to other users.
 * - No Public Listing: The listing of top-level user documents is explicitly disallowed to protect user privacy
 *   and prevent data scraping.
 * - Path-Based Security: The `{userId}` in the document path is the primary key for all authorization checks,
 *   making the rules fast, efficient, and easy to understand.
 *
 * Denormalization for Authorization:
 * To ensure data integrity, each `Property` document contains a `userId` field. The rules enforce that this
 * field matches the `{userId}` from the path upon creation and that it cannot be changed upon update. This
 * creates a permanent, auditable link between a property and its owner directly within the document,
 * simplifying security logic and client-side queries.
 *
 * Structural Segregation:
 * The current structure places all properties within a user's private subcollection. This is a secure
 * pattern for user-owned content. If public properties were required in the future, a separate top-level
 * `/publicProperties` collection would be recommended to maintain a clear security boundary.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the foundation of the ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete
     * operations to prevent acting on non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own profile document.
     * @deny (get) User 'A' trying to read the profile of user 'B'.
     * @principle Restricts access to a user's own data tree and enforces relational integrity.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages property documents owned by a specific user.
     * @path /users/{userId}/properties/{propertyId}
     * @allow (create) An authenticated user creating a property listing under their own user ID.
     * @deny (update) User 'A' trying to update a property owned by user 'B'.
     * @principle Enforces document ownership for all operations and validates the owner link.
     */
    match /users/{userId}/properties/{propertyId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}